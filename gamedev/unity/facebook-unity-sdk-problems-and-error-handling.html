<!DOCTYPE html>
<html lang="en">

  
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>
        
        Facebook Unity SDK Problems and Error Handling &middot; Ivan Fateev&#039;s Blog
        
    </title>

    <meta property="og:type" content="website" />
    <meta property="og:title" content="Facebook Unity SDK Problems and Error Handling" />
    <meta property="og:description" content="Facebook Unity SDK Problems and Error Handling" />

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/main.css">
    <!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700"> -->

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/wp-content/uploads/2012/09/favicon.png">

    <style>


        .post-title {
            font-size: 2rem;
        }

        nav {
            margin-bottom: 1rem;
        }

        footer {
            clear: both;
        }

        .skills {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 10px;
            margin-right: 1rem;
        }

        section.about {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-gap: 10px;
        }

        .about-pic {
            min-width: 300px;
            width: 20%;
            text-align: center;
            margin-right: 1rem;
            grid-column: 2;

        }

        .social-links {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
        }

        .social-links img {
            width: 50px;
        }

        .about-details {
            grid-column: span 3;
        }

        @media (min-width: 600px) {
            .skills {
                margin-right: 0px;
            }
            .about-details {
                grid-column: 1 none;
            }
        }


        .skill-value {
            margin-top: 0.2rem;
            border: solid 1px #ccc;
            height: 0.7rem;
            max-width: 300px;
            width: 100%;
        }
        .skill-value div {
            background-color: #aaa;
            height: 100%;
        }


        .catalogue-item {
            border: none;
            padding: 0px;
        }

        div.tags, div.tags a {
            /* display: none; */
            border: 0px;
            padding: 0px;
            color: #aaa;
        }

        div.tags a {
            text-decoration: underline;
        }

        div.tags {
            border-bottom: 1px solid #e5e5e5;
            padding-bottom: 2rem;
            margin-bottom: 2rem;
        }

        .post img {
            /* float: left; */
            padding-bottom: 1rem;
        }

        .catalogue-item img {
            /* width: 100px; */
            margin-right: 1rem;
            max-width: 100%;
            max-height: 400px;
        }

        div.pagination {
            clear: both;
        }

        pre {
            tab-size: 2;
        }

        html {
            /* font-family: 'Times New Roman', Roman, serif; */
            font-size: large;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif
        }

    </style>
</head>

  <body>
    <nav class="nav">
      <div class="nav-container">
        <a href="/">
          <h2 class="nav-title">Ivan Fateev&#039;s Blog</h2>
        </a>
        <ul>
          <li><a href="/about">About</a></li>
        </ul>
      </div>
    </nav>

    <main>
        <section id="content">
            <div class="post">
  <div class="post-info">
    <span>Written by</span>
    
        Poisonous John
    

    
      <br>
      <span>on&nbsp;</span><time datetime="2015-08-05 13:58:45 +0300">August 05, 2015</time>
    
  </div>

  <h1 class="post-title">Facebook Unity SDK Problems and Error Handling</h1>
  <div class="post-line"></div>

  <p><a href="http://fateev.pro/wp-content/uploads/2014/05/67a6bfe5cb2.png"><img class="alignleft wp-image-307 size-medium" src="http://fateev.pro/wp-content/uploads/2014/05/67a6bfe5cb2-300x300.png" alt="Facebook Unity SDK" width="300" height="300" /></a></p>

<p>Unity is quite useful. But every tool has its own cons. One of that cons is a WWW class - some kind of HTTP wrapper. You might say: “What’s wrong with it? It’s quite handy!”. Yes, it is, till you need to work with some kind of REST API.<!--more--></p>

<p>Most of the REST services and also OAuth 2.0 spec using http error codes to inform user about some kind of error. But along with error code service provides response that contains details about an error because just an error code is not enough to understand what to do with such error. Facebook Open Graph API is one of such services. <a href="https://developers.facebook.com/docs/graph-api/using-graph-api/v2.4#errors" target="_blank" rel="nofollow">Documentation states</a> that in case of error we should parse JSON response and look to the error code and other error details to understand what’s wrong.
Common error response looks like this:</p>
<pre> 
<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript">      <span class="p">{</span>
       <span class="s2">"error"</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">"message"</span><span class="p">:</span> <span class="s2">"Message describing the error"</span><span class="p">,</span>
         <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"OAuthException"</span><span class="p">,</span>
         <span class="s2">"code"</span><span class="p">:</span> <span class="mi">190</span><span class="p">,</span>
         <span class="s2">"error_subcode"</span><span class="p">:</span> <span class="mi">460</span><span class="p">,</span>
         <span class="s2">"error_user_title"</span><span class="p">:</span> <span class="s2">"A title"</span><span class="p">,</span>
         <span class="s2">"error_user_msg"</span><span class="p">:</span> <span class="s2">"A message"</span>
       <span class="p">}</span>
     <span class="p">}</span>
 </code></pre></figure>

</pre>
<p>The most important error in my case is <strong>invalid token</strong>. In that case we should reauthorize user in our app. If it won’t be done, all queries to API will fail. This breaks all the things. Facebook Unity SDK provides <strong>FBResult</strong> class to read repsonse from facebook’s API. Problem that I’m talking about is that</p>
<blockquote><strong> You can't use FBResult to handle facebook API errors.</strong></blockquote>
<p>You might say: Why? It has an <strong>FBResult.Error</strong> property for that”. But what that property is for? It has a string type and all you can get from it is a text description of an error like “400 Bad Response”. Is that informative for you? Neither for me. Open graph API returns 400 http error code if ANY error occurs. I assumed that <strong>FBResult.Text</strong> property should contain a JSON describing the error like stated in documentation. It’s not! You can’t retrieve error’s JSON! Why?</p>
<blockquote><strong>Unity's WWW class doesn't allow you to get response if error code not equals 200 (Success). </strong></blockquote>
<p>If you look at FBResult class in a debugger while receiving a response you see that FBResult’s contains a data member which value is a WWW object. That’s why the FBResult.Text property is empty when an error occurs. You might see an error in unity’s console in such case: <strong>“You are trying to load data from a www stream which had the following error when downloading. 400 Bad Request”.</strong></p>

<p>It’s absolutely pointless to forbid read a response if the response code not equals 200. It violates OAuth specifications. It’s a bug and it exists in unity for years. Facebook developers that worked with Facebook Unity SDK knew it for sure and just ignored it. They just don’t care about it. Facebook Unity SDK is outdated and updated rarely. Features like Share Dialog isn’t supported.</p>

<p>Fortunately Open Graph SDK provides error details in HTTP Headers! To solve problem with error handling I use some hack. I would avoid it if situation wouldn’t be so awful. I use reflection to get protected FBResult.data field. As I mentioned before that field contains WWW object that I can use to retrieve http headers. Here is a part of my class:</p>
<pre>
<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text.RegularExpressions</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">LitJson</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">Glu.ContractKiller3</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Glu.Localization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Glu.JSON</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Glu.Facebook</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">SDKError</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">message</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">type</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">code</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">error_subcode</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">error_user_title</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">error_user_msg</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">static</span> <span class="n">SDKError</span> <span class="nf">CreateFromHeaders</span><span class="p">(</span><span class="n">Dictionary</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">headers</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">headers</span><span class="p">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="s">"WWW-AUTHENTICATE"</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="kt">string</span> <span class="n">header</span> <span class="p">=</span> <span class="n">headers</span><span class="p">[</span><span class="s">"WWW-AUTHENTICATE"</span><span class="p">];</span>
                <span class="kt">var</span> <span class="n">components</span> <span class="p">=</span>
                    <span class="n">Regex</span>
                        <span class="p">.</span><span class="nf">Matches</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s">@"(?[^\s""]+)|""(?[^""]*)"""</span><span class="p">)</span>
                        <span class="p">.</span><span class="nf">Cast</span><span class="p">().</span><span class="nf">ToList</span><span class="p">()</span>
                    <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">m</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">m</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="s">"match"</span><span class="p">].</span><span class="n">Value</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">ToList</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">components</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;</span><span class="n">amp</span><span class="p">;&amp;</span><span class="n">amp</span><span class="p">;</span>
                    <span class="n">components</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">4</span> <span class="p">&amp;</span><span class="n">amp</span><span class="p">;&amp;</span><span class="n">amp</span><span class="p">;</span>
                    <span class="n">components</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">==</span> <span class="s">"OAuth"</span> <span class="p">&amp;</span><span class="n">amp</span><span class="p">;&amp;</span><span class="n">amp</span><span class="p">;</span>
                    <span class="n">components</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">==</span> <span class="s">"Facebook Platform"</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">err</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SDKError</span><span class="p">();</span>
                    <span class="n">err</span><span class="p">.</span><span class="nf">SetOAuthError</span><span class="p">();</span>
                    <span class="n">err</span><span class="p">.</span><span class="nf">SetReloginRequired</span><span class="p">();</span>
                    <span class="n">err</span><span class="p">.</span><span class="n">message</span> <span class="p">=</span> <span class="n">components</span><span class="p">[</span><span class="m">3</span><span class="p">];</span>
                    <span class="n">err</span><span class="p">.</span><span class="n">error_user_title</span> <span class="p">=</span> <span class="s">"Facebook Error"</span><span class="p">;</span>
                    <span class="n">err</span><span class="p">.</span><span class="n">error_user_msg</span> <span class="p">=</span> <span class="n">err</span><span class="p">.</span><span class="n">message</span><span class="p">;</span>
                    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">}</span>

    <span class="k">static</span> <span class="k">class</span> <span class="nc">SDKErrorExtensions</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="n">SDKError</span> <span class="nf">ToSDKError</span><span class="p">(</span><span class="k">this</span> <span class="n">FBResult</span> <span class="n">result</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">SDKError</span> <span class="n">err</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">_fbResultDataField</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_fbResultDataField</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="nf">GetType</span><span class="p">().</span><span class="nf">GetField</span><span class="p">(</span><span class="s">"data"</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">);</span>
                <span class="p">}</span>


                <span class="kt">var</span> <span class="n">www</span> <span class="p">=</span> <span class="n">_fbResultDataField</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">as</span> <span class="n">UnityEngine</span><span class="p">.</span><span class="n">WWW</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">www</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">www</span><span class="p">.</span><span class="n">bytesDownloaded</span> <span class="p">==</span> <span class="m">0</span> <span class="p">||</span> <span class="n">www</span><span class="p">.</span><span class="n">responseHeaders</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">err</span> <span class="p">=</span> <span class="n">SDKError</span><span class="p">.</span><span class="nf">CreateNetworkError</span><span class="p">();</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="p">{</span>
                        <span class="n">err</span> <span class="p">=</span> <span class="n">SDKError</span><span class="p">.</span><span class="nf">CreateFromHeaders</span><span class="p">(</span><span class="n">www</span><span class="p">.</span><span class="n">responseHeaders</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>

            <span class="p">}</span>



            <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">static</span> <span class="n">FieldInfo</span> <span class="n">_fbResultDataField</span><span class="p">;</span>

    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</pre>
<p>I cache FieldInfo to make reflection queries a little bit faster. Also I check bytesDownloaded and response headers to know if error caused by network problems. If not I check WWW-AUTHENTICATE header that facebook fills with error details. Regular expression required to parse a data in the header. Example of a Header’s data:</p>
<pre>OAuth "Facebook Platform" "invalid_token" "Token is invalid because user logged out."
</pre>
<p>As you see the data format is kind of odd. But I retrieve data by sentences (a single word OR a statement between double quotes). Last part of a header is a message that we can log or display to user. invalid_token chunk looks like error type, so we can use it to decide how to deal with this error.</p>

<p>As an alternative to my hack you can use WebRequest but I wouldn’t recommend rely on it.</p>


</div>

<div class="pagination">
  
    <a href="/chronicles/cinnamon-zastavil-skuchat-po-linux.html" class="left arrow">&#8592;</a>
  
  
    <a href="/chronicles/smiley-boom-perviy-krupniy-reliz.html" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>

        </section>
    </main>

    <footer>
      <div class="tolstoycomments-feed"></div>
      <span>
        &copy; <time datetime="2018-10-17 17:33:01 +0300">2018</time> . Made with Jekyll using the <a href="https://github.com/chesterhow/tale/">Tale</a> theme.
      </span>

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-34509649-1', 'auto');
        ga('send', 'pageview');

    </script>

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript" >
        (function (d, w, c) {
            (w[c] = w[c] || []).push(function() {
                try {
                    w.yaCounter16940533 = new Ya.Metrika({
                        id:16940533,
                        clickmap:true,
                        trackLinks:true,
                        accurateTrackBounce:true,
                        webvisor:true
                    });
                } catch(e) { }
            });

            var n = d.getElementsByTagName("script")[0],
                s = d.createElement("script"),
                f = function () { n.parentNode.insertBefore(s, n); };
            s.type = "text/javascript";
            s.async = true;
            s.src = "https://mc.yandex.ru/metrika/watch.js";

            if (w.opera == "[object Opera]") {
                d.addEventListener("DOMContentLoaded", f, false);
            } else { f(); }
        })(document, window, "yandex_metrika_callbacks");
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/16940533" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
    <script type="text/javascript">!(function(w,d,s,l,x){w[l]=w[l]||[];var f=d.getElementsByTagName(s)[0],j=d.createElement(s);j.async=!0;j.src='//web.tolstoycomments.com/sitejs/app.js?i='+l+'&x='+x+'&t='+(new Date().getTime());f.parentNode.insertBefore(j,f)})(window,document,'script','tolstoycomments','1462');
    window.tolstoycomments.config = {
        desktop_class: 'tolstoycomments-feed'
    };
    </script>
    </footer>
  </body>
</html>